#!/bin/bash

INPUTPREFIX=$1
SVMFILE="$INPUTPREFIX.svm.txt"
RANGE="$INPUTPREFIX.svm.range.txt"
FULLSCALE="$INPUTPREFIX.svm.scale.txt"

## SVM file building parameters
NUMCASEPATHS=0
NUMCTRLPATHS=0
MINSIZE=0
MINSUPPORT=100
MINPRIORITY=1

## grid scan
GRIDOUT="$INPUTPREFIX.svm.grid.txt"
K=10
LOG10C="-6,6,1"
LOG10GAMMA="-8,1,1"
NGRIDCASES=100
NGRIDCONTROLS=100

# LOG10C="0,0,1"
# LOG10GAMMA="-3,-1,0.5"

## SVM
NRUNS=10
NSVMCASES=0
NSVMCONTROLS=0

#####################################
## delete SVM files to force rebuild
#rm -f $SVMFILE
rm -f $RANGE
rm -f $FULLSCALE
rm -f $GRIDOUT
#####################################

## write the SVM file
if [ ! -s $SVMFILE ]
then
    echo "Writing $SVMFILE with -ncase $NUMCASEPATHS -nctrl $NUMCTRLPATHS -s $MINSIZE -m $MINSUPPORT -minp $MINPRIORITY"
    java -server -Xms10g -Xmx500g -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -cp "build/install/fr/lib/*" org.ncgr.pangenomics.genotype.fr.FRUtils \
	 -svm -i $INPUTPREFIX -ncase $NUMCASEPATHS -nctrl $NUMCTRLPATHS -s $MINSIZE -m $MINSUPPORT -minp $MINPRIORITY
fi

## scale the SVM data
if [ ! -s $FULLSCALE ]
then
    echo "Scaling $SVMFILE"
    java -server -Xms10g -Xmx500g -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -cp "build/install/fr/lib/*" org.ncgr.svm.SvmScaler -s $RANGE -d $SVMFILE > $FULLSCALE
fi

## run GridSearcher on the full scaled data to find optimum SVM parameters
# if [ ! -s $GRIDOUT ]
# then
#    starttime=`date`
#    ARGS="-datafile $FULLSCALE -log10C $LOG10C -log10gamma $LOG10GAMMA -k $K -ncases $NGRIDCASES -ncontrols $NGRIDCONTROLS"
#    echo "Running GridSearcher with $ARGS"
#    java -server -Xms10g -Xmx600g -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -cp "build/install/fr/lib/*" org.ncgr.svm.GridSearcher $ARGS > $GRIDOUT
#    endtime=`date`
#    echo "$starttime - $endtime"
# fi

## set SVM parameters, default or from GridSearcher
ARGS="-h 0 -m 10000 -C 1.0 -k $K -ncases $NSVMCASES -ncontrols $NSVMCONTROLS"
if [ -s $GRIDOUT ]
then
    C=`tail -1 $GRIDOUT | awk '{ print $1; }'`
    gamma=`tail -1 $GRIDOUT | awk '{ print $2; }'`
    perc=`tail -1 $GRIDOUT | awk '{ print $3; }'`
    ARGS="-C $C -gamma $gamma -k $K -ncases $NSVMCASES -ncontrols $NSVMCONTROLS"
fi

## run the cross-validation
echo "Running $NRUNS SvmCrossValidator runs on $FULLSCALE with $ARGS"
java -server -Xms10g -Xmx500g -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -cp "build/install/fr/lib/*" org.ncgr.svm.SvmCrossValidator \
     $ARGS -nruns $NRUNS -i $FULLSCALE > "$INPUTPREFIX.crossvalidation.txt"
